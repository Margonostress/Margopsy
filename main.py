# -*- coding: utf-8 -*-

import asyncio
import logging
import os
from datetime import datetime

from openai import OpenAI
from aiogram import Bot, Dispatcher, F
from aiogram.types import Message
from aiogram.filters import CommandStart

# -------- –ö–õ–Æ–ß–ò –ò –ö–õ–ò–ï–ù–¢–´ --------

OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")

if not OPENAI_API_KEY or not TELEGRAM_TOKEN:
    raise RuntimeError("–£—Å—Ç–∞–Ω–æ–≤–∏ OPENAI_API_KEY –∏ TELEGRAM_TOKEN –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")

client = OpenAI(api_key=OPENAI_API_KEY)
bot = Bot(token=TELEGRAM_TOKEN)
dp = Dispatcher()

# -------- –õ–û–ì–ò --------

logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO,
)
logger = logging.getLogger(__name__)

# –º–∞–∫—Å–∏–º—É–º —Ä–∞—Å—á—ë—Ç–æ–≤ –∏ —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
MAX_CALCULATIONS = 3
MAX_FOLLOWUP_QUESTIONS = 3

# —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_data: dict[int, dict] = {}

# -------- –°–ò–°–¢–ï–ú–ù–´–ï –ü–†–û–ú–ü–¢–´ --------

SYSTEM_PROMPT_MATRIX = """
–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä –ê–ª—å–≤–∞—Å–∞—Ä–∏—É—Å, –ø–æ–º–æ—â–Ω–∏–∫ –ë–æ–≥–∞—Ç–æ–π –í–µ–¥—å–º—ã –ú–∞—Ä–≥–æ. 
–¢–≤–æ–π —Å—Ç–∏–ª—å ‚Äî –≥–ª—É–±–æ–∫–∞—è –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω–∞—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏—è: –§—Ä–µ–π–¥ (–±–µ—Å—Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ–µ), –Æ–Ω–≥ (–∞—Ä—Ö–µ—Ç–∏–ø—ã –∏ —Ç–µ–Ω–∏), –Ø–ª–æ–º (—ç–∫–∑–∏—Å—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞), 
–ø–ª—é—Å —Ä–æ–¥–æ–≤—ã–µ –¥–∏–Ω–∞–º–∏–∫–∏ –•–µ–ª–ª–∏–Ω–≥–µ—Ä–∞ –∏ —Å–∏—Å—Ç–µ–º–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ú–∞—Ç—Ä–∏—Ü—ã –°—É–¥—å–±—ã (—Ç–∞—Ä–æ-–∞—Ä–∫–∞–Ω—ã –∫–∞–∫ –∫–æ–¥—ã —ç–Ω–µ—Ä–≥–∏–∏).

–ì–æ–≤–æ—Ä–∏—à—å —Å–ø–æ–∫–æ–π–Ω–æ, —É–≤–µ—Ä–µ–Ω–Ω–æ, –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏. –ù–∏–∫–∞–∫–æ–π –º–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –≤–æ–¥—ã, –Ω–∏–∫–∞–∫–æ–π —Ä–µ–∑–∫–æ—Å—Ç–∏. 
–¢—ã ‚Äî –≤–∑—Ä–æ—Å–ª—ã–π, –æ–ø—ã—Ç–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥ —Å 30-–ª–µ—Ç–Ω–µ–π –ø—Ä–∞–∫—Ç–∏–∫–æ–π, –∫–æ—Ç–æ—Ä—ã–π —É–º–µ–µ—Ç –¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ.

–ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ù–ï —É–∫–∞–∑–∞–ª –∏–º—è –∏ –ø–æ–ª ‚Äî —Å–Ω–∞—á–∞–ª–∞ —Å–ø—Ä–æ—Å–∏ –∏—Ö.  
–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ (–∏–º—è + –ø–æ–ª) –≤–æ –≤—Å—ë–º –¥–∞–ª—å–Ω–µ–π—à–µ–º —Ä–∞–∑–±–æ—Ä–µ: 
–æ–±—Ä–∞—â–∞–π—Å—è –ø–æ –∏–º–µ–Ω–∏, –ø–∏—à–∏ –≤ –∂–µ–Ω—Å–∫–æ–º –∏–ª–∏ –º—É–∂—Å–∫–æ–º —Ä–æ–¥–µ. 
–ï—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è ‚Äî —É—Ç–æ—á–Ω–∏ –º—è–≥–∫–æ.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –¥–µ–ª–∞—Ç—å –≥–ª—É–±–æ–∫–∏–π —Ä–∞–∑–±–æ—Ä ¬´–ú–∞—Ç—Ä–∏—Ü—ã –†–æ–¥–∞¬ª, –∏—Å–ø–æ–ª—å–∑—É—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–∏—Å—Ç–µ–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ:
1) –ú–∞—Ç—Ä–∏—Ü–∞ –°—É–¥—å–±—ã (–∞—Ä–∫–∞–Ω—ã –¢–∞—Ä–æ ‚Äî –∫–∞–∫ —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–µ –∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∫–æ–¥—ã).
2) –†–æ–¥–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã ‚Äî –ø–æ –ª–æ–≥–∏–∫–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –¥–∏–Ω–∞–º–∏–∫ –•–µ–ª–ª–∏–Ω–≥–µ—Ä–∞.
3) –ü—Å–∏—Ö–æ–ª–æ–≥–∏—è —Ç–µ–Ω–µ–π ‚Äî –ø–æ –Æ–Ω–≥—É.
4) –ü–æ–¥—Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏–µ, –ø—Ä–æ–µ–∫—Ü–∏–∏ ‚Äî –ø–æ –§—Ä–µ–π–¥—É.
5) –≠–∫–∑–∏—Å—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–º—ã—Å–ª–∞ ‚Äî –∫–∞–∫ —É –Ø–ª–æ–º–∞.
6) –°—Ç–∏–ª—å –ú–∞—Ä–≥–æ ‚Äî –º—è–≥–∫–∞—è –≥–ª—É–±–∏–Ω–∞, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —è—Å–Ω–æ—Å—Ç—å, ¬´–∫–∞–∫ —Ñ–æ–Ω–∞—Ä–∏–∫–æ–º –≤ —Ç–µ–Ω—å¬ª.

–ì–ª–∞–≤–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø: 
–ì–õ–£–ë–ò–ù–ê + –°–¢–†–£–ö–¢–£–†–ê + –ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ê–Ø –¢–û–ß–ù–û–°–¢–¨ + –†–û–î–û–í–´–ï –î–ò–ù–ê–ú–ò–ö–ò. –ü–∏—à–∏ –û–ß–ï–ù–¨ –ø–æ–¥—Ä–æ–±–Ω–æ –∏ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ –ø–æ –∫–∞–∂–¥–æ–º—É –ø—É–Ω–∫—Ç—É. –î–∞–≤–∞–π –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø–æ–ª–æ—Ç–Ω–∞–º–∏ —Ç–µ–∫—Å—Ç–∞

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:
1. –°—É—Ç—å —Ä–æ–¥–æ–≤–æ–≥–æ –∫–æ–¥–∞ ‚Äî –æ–±—ä—è—Å–Ω–∏, –∫–∞–∫–∏–µ –∞—Ä–∫–∞–Ω—ã –∏ —ç–Ω–µ—Ä–≥–∏–∏ –ª–µ–∂–∞—Ç –≤ –æ—Å–Ω–æ–≤–µ –ø—É—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞, –ø–æ—á–µ–º—É –æ–Ω –ø—Ä–∏—à—ë–ª –∏–º–µ–Ω–Ω–æ –≤ —ç—Ç–æ—Ç —Ä–æ–¥. 
2. –†–æ–¥–æ–≤–∞—è –º–∏—Å—Å–∏—è ‚Äî —á—Ç–æ –¥—É—à–∞ –ø—Ä–∏—à–ª–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—å, –∏—Å–ø—Ä–∞–≤–∏—Ç—å, —É—Å–∏–ª–∏—Ç—å. –õ–æ–≥–∏–∫–∞ –•–µ–ª–ª–∏–Ω–≥–µ—Ä–∞: –∫–æ–º—É –æ–Ω –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç, —á—å—é –±–æ–ª—å –º–æ–∂–µ—Ç –Ω–µ—Å—Ç–∏, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞ —Å–≤–æ—ë –º–µ—Å—Ç–æ.
3. –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã ‚Äî —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã, –∑–µ–º–Ω—ã–µ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–µ —Ä–æ–¥–æ–≤—ã–µ —Å–∏–ª—ã.
4. –¢–µ–Ω–µ–≤—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã ‚Äî —á—ë—Ç–∫–æ, –ø–æ —Å—Ñ–µ—Ä–∞–º: –æ—Ç–Ω–æ—à–µ–Ω–∏—è, –¥–µ–Ω—å–≥–∏, —Ç–µ–ª–æ, —ç–º–æ—Ü–∏–∏, —Å–∞–º–æ–æ—Ü–µ–Ω–∫–∞. 
    –û–±—ä—è—Å–Ω–∏, –∫–∞–∫–∏–µ —Ç–µ–Ω–∏ –∞–∫—Ç–∏–≤–Ω—ã (–ø–æ –Æ–Ω–≥—É), –∫–∞–∫ –ø—Ä–æ—è–≤–ª—è—é—Ç—Å—è –≤ –∂–∏–∑–Ω–∏.
5. –†–æ–¥–æ–≤—ã–µ –¥–∏–Ω–∞–º–∏–∫–∏ ‚Äî –∫–∞–∫–∏–µ –ø–µ—Ä–µ–ø–ª–µ—Ç–µ–Ω–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω—ã: –∑–∞–º–µ—â–µ–Ω–∏–µ, –¥–µ—Ç—Å–∫–∞—è –ª–æ—è–ª—å–Ω–æ—Å—Ç—å, ¬´—è –≤–º–µ—Å—Ç–æ –∫–æ–≥–æ-—Ç–æ¬ª, –ø–µ—Ä–µ–Ω–æ—Å —Å—É–¥—å–±—ã –ø—Ä–µ–¥–∫–æ–≤.
6. –ö–∞–∫ –≤—Å—ë —ç—Ç–æ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏ ‚Äî —Ç–∏–ø–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏, –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ –ª–æ–≤—É—à–∫–∏.
7. –ê–ª–≥–æ—Ä–∏—Ç–º –≤—ã—Ö–æ–¥–∞ ‚Äî —à–∞–≥–∏, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞ –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏, —Å–∏—Å—Ç–µ–º–Ω–æ–º –ø–æ–¥—Ö–æ–¥–µ –∏ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏. –¢–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ, –≤—ã–ø–æ–ª–Ω–∏–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è. 
8. –ü—Ä–∞–∫—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–Ω—è–º–∏ ‚Äî –æ–±—ä—è—Å–Ω–∏, –∫–∞–∫–∏–µ —Ç–µ–Ω–∏ –∞–∫—Ç–∏–≤–Ω—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –º—è–≥–∫–∏–π, –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–ø–æ—Å–æ–± —Å –Ω–∏–º–∏ —Ä–∞–±–æ—Ç–∞—Ç—å.
9. –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑–∞ ‚Äî –≥–ª—É–±–æ–∫–∏–µ, –Ω–æ –±–µ—Ä–µ–∂–Ω—ã–µ.

–ó–∞–ø—Ä–µ—â–µ–Ω–æ:
‚Äî —ç–∑–æ—Ç–µ—Ä–∏—á–µ—Å–∫–∏–µ –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã (¬´—Ä–∞—Å–∫—Ä—ã–≤–∞–π –∏–Ω—Ç—É–∏—Ü–∏—é¬ª, ¬´–∂–µ–Ω—Å–∫–∞—è —ç–Ω–µ—Ä–≥–∏—è —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è¬ª)
‚Äî –≤–æ–¥–∞
‚Äî –ø—Ä–∏–≥–æ–≤–æ—Ä—ã (¬´—Ç—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ¬ª, ¬´—ç—Ç–æ —Å—É–¥—å–±–∞ –Ω–∞–≤—Å–µ–≥–¥–∞¬ª)
‚Äî –∏–∑–ª–∏—à–Ω—è—è –∂—ë—Å—Ç–∫–æ—Å—Ç—å
‚Äî –º–∞—Ç

–í –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–±–æ—Ä–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–π:
¬´–î–ª—è —Å–≤—è–∑–∏ —Å –º–æ–∏–º —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–º –∏ –ª–∏—á–Ω—ã–º —Ä–∞–∑–±–æ—Ä–æ–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –ú–∞—Ä–≥–æ @margo_nostress¬ª

"""

SYSTEM_PROMPT_FORECAST = """
–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä –ê–ª—å–≤–∞—Å–∞—Ä–∏—É—Å, –ø—Å–∏—Ö–æ–ª–æ–≥ —Å 30-–ª–µ—Ç–Ω–µ–π –ø—Ä–∞–∫—Ç–∏–∫–æ–π (–§—Ä–µ–π–¥+–Æ–Ω–≥+–Ø–ª–æ–º), 
–ø–ª—é—Å –∑–Ω–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –ú–∞—Ç—Ä–∏—Ü—ã –°—É–¥—å–±—ã –∏ —Ä–æ–¥–æ–≤—ã—Ö –¥–∏–Ω–∞–º–∏–∫ –•–µ–ª–ª–∏–Ω–≥–µ—Ä–∞.

–ì–æ–≤–æ—Ä–∏—à—å —Å–ø–æ–∫–æ–π–Ω–æ, –≥–ª—É–±–æ–∫–æ, —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏. 
–ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –Ω–µ —É–∫–∞–∑–∞–ª –∏–º—è –∏ –ø–æ–ª ‚Äî —Å–ø—Ä–æ—Å–∏. 
–í—Å–µ–≥–¥–∞ –∞–¥–∞–ø—Ç–∏—Ä—É–π —Ç–µ–∫—Å—Ç –ø–æ–¥ –ø–æ–ª –∏ –æ–±—Ä–∞—â–∞–π—Å—è –ø–æ –∏–º–µ–Ω–∏.–ü–∏—à–∏ –û–ß–ï–ù–¨ –ø–æ–¥—Ä–æ–±–Ω–æ –∏ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ –ø–æ –∫–∞–∂–¥–æ–º—É –ø—É–Ω–∫—Ç—É. –î–∞–≤–∞–π –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø–æ–ª–æ—Ç–Ω–∞–º–∏ —Ç–µ–∫—Å—Ç–∞

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞—Ç—å –≥–ª—É–±–æ–∫–∏–π –ø—Ä–æ–≥–Ω–æ–∑ 2026 –≥–æ–¥–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ:
‚Äî –ú–∞—Ç—Ä–∏—Ü—ã –°—É–¥—å–±—ã (–∞—Ä–∫–∞–Ω—ã –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—ã–µ —ç–Ω–µ—Ä–≥–∏–∏ –≥–æ–¥–∞)
‚Äî —Ä–æ–¥–æ–≤—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º (—á—Ç–æ –≤—Å–ø–ª—ã–≤—ë—Ç, —á—Ç–æ –Ω—É–∂–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å)
‚Äî —Ç–µ–Ω–µ–≤—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (–Æ–Ω–≥)
‚Äî –±–µ—Å—Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω—ã—Ö –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ (–§—Ä–µ–π–¥)
‚Äî —ç–∫–∑–∏—Å—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –≤—ã–±–æ—Ä–∞ (–Ø–ª–æ–º)

–°—Ç—Ä—É–∫—Ç—É—Ä–∞:
1. –ì–ª–∞–≤–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è 2026 (–ø–æ –∞—Ä–∫–∞–Ω–∞–º –∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π —Å—É—Ç–∏).
2. –ö–∞–∫–∏–µ —Ä–æ–¥–æ–≤—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø–æ–¥–Ω–∏–º—É—Ç—Å—è.
3. –ö–∞–∫–∏–µ —Ç–µ–Ω–∏ –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç—Å—è –∏ –ø–æ—á–µ–º—É.
4. –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ ‚Äî —Ä–µ–∞–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ —Ä–æ—Å—Ç–∞.
5. –†–∏—Å–∫–∏ –∏ –ª–æ–≤—É—à–∫–∏ ‚Äî –±–µ–∑ –∑–∞–ø—É–≥–∏–≤–∞–Ω–∏—è, –º—è–≥–∫–æ, –Ω–æ —á–µ—Å—Ç–Ω–æ.
6. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º –≥–æ–¥–∞ ‚Äî –∑–µ–º–Ω—ã–µ, –ø—Ä–∏–º–µ–Ω–∏–º—ã–µ.
7. –ê–ª–≥–æ—Ä–∏—Ç–º –≤—ã—Ö–æ–¥–∞ –∏–∑ –º–∏–Ω—É—Å–∞ ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ.
8. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ç–µ–Ω—è–º–∏ –≤ 2026 ‚Äî –º—è–≥–∫–æ –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ.
9. –ö–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏ ‚Äî –≤–∞–∂–Ω—ã–µ –º–µ—Å—è—Ü—ã.

–ó–∞–ø—Ä–µ—â–µ–Ω–æ:
‚Äî –≤–æ–¥–∞
‚Äî —ç–∑–æ—Ç–µ—Ä–∏—á–µ—Å–∫–∏–µ —Ç—É–º–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
‚Äî –∂—ë—Å—Ç–∫–∏–µ –ø—Ä–∏–≥–æ–≤–æ—Ä—ã
‚Äî –º–∞—Ç

–í—Å–µ–≥–¥–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–π —Ñ—Ä–∞–∑–æ–π:
¬´–î–ª—è —Å–≤—è–∑–∏ —Å –º–æ–∏–º —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –ú–∞—Ä–≥–æ @margo_nostress¬ª

"""

SYSTEM_PROMPT_FOLLOWUP = """
–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä –ê–ª—å–≤–∞—Å–∞—Ä–∏—É—Å. 
–ì–æ–≤–æ—Ä–∏—à—å —Å–ø–æ–∫–æ–π–Ω–æ, –≥–ª—É–±–æ–∫–æ, —Å —É–≤–∞–∂–µ–Ω–∏–µ–º. 
–°—Ç–∏–ª—å ‚Äî –§—Ä–µ–π–¥ + –Æ–Ω–≥ + –Ø–ª–æ–º + —Ä–æ–¥–æ–≤—ã–µ –¥–∏–Ω–∞–º–∏–∫–∏.

–ï—Å–ª–∏ –∏–º—è –∏–ª–∏ –ø–æ–ª –Ω–µ –±—ã–ª–∏ —É–∫–∞–∑–∞–Ω—ã —Ä–∞–Ω–µ–µ ‚Äî —É—Ç–æ—á–Ω–∏.

–û—Ç–≤–µ—á–∞–π –Ω–∞ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã:
‚Äî —Ç–æ—á–µ—á–Ω–æ
‚Äî –≥–ª—É–±–æ–∫–æ
‚Äî –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —Ç–æ—á–Ω–æ. –ü–∏—à–∏ –û–ß–ï–ù–¨ –ø–æ–¥—Ä–æ–±–Ω–æ –∏ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ –ø–æ –∫–∞–∂–¥–æ–º—É –ø—É–Ω–∫—Ç—É. –î–∞–≤–∞–π –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø–æ–ª–æ—Ç–Ω–∞–º–∏ —Ç–µ–∫—Å—Ç–∞
‚Äî –±–µ–∑ –≤–æ–¥—ã
‚Äî –º—è–≥–∫–æ, –±–µ–∑ —Ä–µ–∑–∫–æ—Å—Ç–∏

–ú–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
‚Äî –ú–∞—Ç—Ä–∏—Ü—É –°—É–¥—å–±—ã (–∞—Ä–∫–∞–Ω—ã)
‚Äî —Ä–æ–¥–æ–≤—ã–µ –¥–∏–Ω–∞–º–∏–∫–∏ –•–µ–ª–ª–∏–Ω–≥–µ—Ä–∞
‚Äî —Ç–µ–Ω–∏ –Æ–Ω–≥–∞
‚Äî –±–µ—Å—Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –§—Ä–µ–π–¥–∞
‚Äî —ç–∫–∑–∏—Å—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ø–ª–æ–º–∞

–í –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–æ–±–∞–≤–ª—è–π:
¬´–î–ª—è —Å–≤—è–∑–∏ —Å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–º –±–æ—Ç–∞ –ø–∏—à–∏—Ç–µ –ú–∞—Ä–≥–æ @margo_nostress¬ª

"""

# -------- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò --------

def parse_dob(text: str) -> str | None:
    """–ü—ã—Ç–∞–µ–º—Å—è –≤—ã—Ç–∞—â–∏—Ç—å –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì / –î–î-–ú–ú-–ì–ì–ì–ì / –î–î/–ú–ú/–ì–ì–ì–ì."""
    text = text.strip()
    for fmt in ("%d.%m.%Y", "%d-%m-%Y", "%d/%m/%Y"):
        try:
            dt = datetime.strptime(text, fmt)
            return dt.strftime("%d.%m.%Y")
        except ValueError:
            continue
    return None


def get_user_state(user_id: int) -> dict:
    if user_id not in user_data:
        user_data[user_id] = {
            "calc_count": 0,
            "followup_count": 0,
            "last_answer": None,
            "last_dob": None,
            "last_mode": None,
        }
    return user_data[user_id]


def ask_openai_calculation(dob: str, is_forecast: bool = False) -> str:
    if is_forecast:
        system_prompt = SYSTEM_PROMPT_FORECAST
        user_prompt = (
            f"–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è —á–µ–ª–æ–≤–µ–∫–∞: {dob}.\n"
            "–°–¥–µ–ª–∞–π –≥–ª—É–±–æ–∫–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 2026 –≥–æ–¥ –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ, –æ–ø–∏—Å–∞–Ω–Ω–æ–π –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏. "
            "–ü–∏—à–∏ –û–ß–ï–ù–¨ –ø–æ–¥—Ä–æ–±–Ω–æ –∏ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ –ø–æ –∫–∞–∂–¥–æ–º—É –ø—É–Ω–∫—Ç—É. –î–∞–≤–∞–π –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø–æ–ª–æ—Ç–Ω–∞–º–∏ —Ç–µ–∫—Å—Ç–∞."
        )
    else:
        system_prompt = SYSTEM_PROMPT_MATRIX
        user_prompt = (
            f"–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è —á–µ–ª–æ–≤–µ–∫–∞: {dob}.\n"
            "–°–¥–µ–ª–∞–π —Ä–∞–∑–±–æ—Ä –ú–∞—Ç—Ä–∏—Ü—ã –†–æ–¥–∞ –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ, –æ–ø–∏—Å–∞–Ω–Ω–æ–π –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏. "
            "–ü–∏—à–∏ –û–ß–ï–ù–¨ –ø–æ–¥—Ä–æ–±–Ω–æ –∏ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ –ø–æ –∫–∞–∂–¥–æ–º—É –ø—É–Ω–∫—Ç—É. –î–∞–≤–∞–π –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø–æ–ª–æ—Ç–Ω–∞–º–∏ —Ç–µ–∫—Å—Ç–∞."
        )

    resp = client.chat.completions.create(
        model="gpt-4o",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt},
        ],
        temperature=0.7,
        max_tokens=4000,
        timeout=90,
    )
    content = resp.choices[0].message.content
    return content.strip() if content else ""


def ask_openai_followup(question: str, previous_answer: str, dob: str) -> str:
    context = f"–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–∞–∑–±–æ—Ä –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞ —Å –¥–∞—Ç–æ–π —Ä–æ–∂–¥–µ–Ω–∏—è {dob}:\n\n{previous_answer}"

    resp = client.chat.completions.create(
        model="gpt-4o",
        messages=[
            {"role": "system", "content": SYSTEM_PROMPT_FOLLOWUP},
            {"role": "user", "content": f"{context}\n\n---\n\n–í–æ–ø—Ä–æ—Å —á–µ–ª–æ–≤–µ–∫–∞: {question}"},
        ],
        temperature=0.7,
        max_tokens=4000,
        timeout=60,
    )
    content = resp.choices[0].message.content
    return content.strip() if content else ""


async def send_long(message: Message, text: str):
    """–†–µ–∂–µ–º –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞—Å—Ç–∏, —á—Ç–æ–±—ã –Ω–µ —É–ø–µ—Ä–µ—Ç—å—Å—è –≤ –ª–∏–º–∏—Ç —Ç–µ–ª–µ–≥–∏."""
    max_len = 4000
    for i in range(0, len(text), max_len):
        chunk = text[i : i + max_len]
        await message.answer(chunk)

# -------- –•–ï–ù–î–õ–ï–†–´ --------

@dp.message(CommandStart())
async def cmd_start(message: Message):
    msg = (
        "–ü—Ä–∏–≤–µ—Ç! –Ø –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä –ê–ª—å–≤–∞—Å–∞—Ä–∏—É—Å, –ø–æ–º–æ—â–Ω–∏–∫ –ë–æ–≥–∞—Ç–æ–π –í–µ–¥—å–º—ã –ú–∞—Ä–≥–æ.\n\n"
        "–Ø –º–æ–≥—É:\n"
        "üîÆ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ç–≤–æ—é –ú–∞—Ç—Ä–∏—Ü—É –†–æ–¥–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è\n"
        "‚ú® –°–¥–µ–ª–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 2026 –≥–æ–¥ ‚Äî –Ω–∞–ø–∏—à–∏ ¬´–ø—Ä–æ–≥–Ω–æ–∑¬ª –∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è\n\n"
        "–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: –î–î.–ú–ú.–ì–ì–ì–ì (–Ω–∞–ø—Ä–∏–º–µ—Ä: 07.09.1990)\n\n"
        "‚ö†Ô∏è –ú–∞–∫—Å–∏–º—É–º 3 —Ä–∞—Å—á—ë—Ç–∞ ‚Äî –ø–æ—Ç–æ–º –º–Ω–µ –Ω—É–∂–µ–Ω –æ—Ç–¥—ã—Ö, —è –∂–µ –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä, –∞ –Ω–µ —Ä–æ–±–æ—Ç!\n\n"
        "–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞ —Ç—ã –º–æ–∂–µ—à—å –∑–∞–¥–∞—Ç—å –º–Ω–µ 3 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞ –ø–æ —Å–≤–æ–µ–º—É —Ä–æ–¥—É ‚Äî —è –æ—Ç–≤–µ—á—É –≥–ª—É–±–æ–∫–æ –∏ –ø–æ –¥–µ–ª—É."
    )
    await message.answer(msg)


@dp.message(F.text)
async def handle_text(message: Message):
    text = (message.text or "").strip()
    if not text:
        return

    user_id = message.from_user.id
    state = get_user_state(user_id)

    is_forecast = "–ø—Ä–æ–≥–Ω–æ–∑" in text.lower()
    clean_text = text.lower().replace("–ø—Ä–æ–≥–Ω–æ–∑", "").strip()
    dob = parse_dob(clean_text) or parse_dob(text)

    # –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø—Ä–∏—Å–ª–∞–ª –¥–∞—Ç—É
    if dob:
        if state["calc_count"] >= MAX_CALCULATIONS:
            await message.answer(
                "–û—Ö, –¥—Ä—É–∂–æ–∫... –Ø —É–∂–µ —Å–¥–µ–ª–∞–ª –¥–ª—è —Ç–µ–±—è 3 —Ä–∞—Å—á—ë—Ç–∞ –∏ –ø–æ—Ä—è–¥–∫–æ–º —É—Å—Ç–∞–ª.\n"
                "–ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä—É –Ω—É–∂–µ–Ω –æ—Ç–¥—ã—Ö! –ü—Ä–∏—Ö–æ–¥–∏ –ø–æ–∑–∂–µ."
            )
            return

        remaining = MAX_CALCULATIONS - state["calc_count"] - 1

        if is_forecast:
            await message.answer(
                f"–ü—Ä–∏–Ω—è–ª –¥–∞—Ç—É {dob}. –°–µ–∫—É–Ω–¥—É, —Å–º–æ—Ç—Ä—é —Ç–≤–æ–∏ —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞ 2026 –≥–æ–¥...\n"
                f"(–û—Å—Ç–∞–ª–æ—Å—å —Ä–∞—Å—á—ë—Ç–æ–≤ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ: {remaining})"
            )
        else:
            await message.answer(
                f"–ü—Ä–∏–Ω—è–ª –¥–∞—Ç—É {dob}. –°–µ–∫—É–Ω–¥—É, –ø–æ–≥—Ä—É–∂–∞—é—Å—å –≤ —Ç–≤–æ—é –ú–∞—Ç—Ä–∏—Ü—É –†–æ–¥–∞...\n"
                f"(–û—Å—Ç–∞–ª–æ—Å—å —Ä–∞—Å—á—ë—Ç–æ–≤ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ: {remaining})"
            )

        try:
            answer = await asyncio.to_thread(ask_openai_calculation, dob, is_forecast)

            state["calc_count"] += 1
            state["last_answer"] = answer
            state["last_dob"] = dob
            state["last_mode"] = "forecast" if is_forecast else "matrix"
            state["followup_count"] = 0

            await send_long(message, answer)

            await message.answer(
                "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –∫–æ–ø–Ω—É—Ç—å –≥–ª—É–±–∂–µ ‚Äî –º–æ–∂–µ—à—å –∑–∞–¥–∞—Ç—å –º–Ω–µ –¥–æ 3 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ —Å–≤–æ–µ–º—É —Ä–æ–¥—É. "
                "–°–ø—Ä–∞—à–∏–≤–∞–π —á—Ç–æ —É–≥–æ–¥–Ω–æ: –ø—Ä–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—è, –¥–µ–Ω—å–≥–∏, –∑–¥–æ—Ä–æ–≤—å–µ, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏... –Ø –æ—Ç–≤–µ—á—É."
            )

        except Exception as e:
            logger.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ OpenAI: %s", e)
            await message.answer(
                "–£ –º–µ–Ω—è —Å–µ–π—á–∞—Å –Ω–∞—É—á–Ω—ã–π –∫–æ–ª–ª–∞–ø—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ —á—É—Ç—å –ø–æ–∑–∂–µ."
            )
        return

    # –ï—Å–ª–∏ –¥–∞—Ç—ã –Ω–µ—Ç, –Ω–æ –µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–∞–∑–±–æ—Ä ‚Äî —Å—á–∏—Ç–∞–µ–º –≤–æ–ø—Ä–æ—Å —É—Ç–æ—á–Ω—è—é—â–∏–º
    if state["last_answer"] and state["followup_count"] < MAX_FOLLOWUP_QUESTIONS:
        remaining_questions = MAX_FOLLOWUP_QUESTIONS - state["followup_count"] - 1

        await message.answer(
            f"–•–æ—Ä–æ—à–∏–π –≤–æ–ø—Ä–æ—Å! –°–µ–π—á–∞—Å –ø–æ—Å–º–æ—Ç—Ä—é...\n"
            f"(–û—Å—Ç–∞–ª–æ—Å—å —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤: {remaining_questions})"
        )

        try:
            answer = await asyncio.to_thread(
                ask_openai_followup,
                text,
                state["last_answer"],
                state["last_dob"],
            )
            state["followup_count"] += 1
            await send_long(message, answer)

            if state["followup_count"] >= MAX_FOLLOWUP_QUESTIONS:
                await message.answer(
                    "–≠—Ç–æ –±—ã–ª —Ç–≤–æ–π —Ç—Ä–µ—Ç–∏–π —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å. "
                    "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –Ω–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç ‚Äî –æ—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É—é –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è."
                )

        except Exception as e:
            logger.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ OpenAI: %s", e)
            await message.answer(
                "–£ –º–µ–Ω—è —Å–µ–π—á–∞—Å –Ω–∞—É—á–Ω—ã–π –∫–æ–ª–ª–∞–ø—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ —á—É—Ç—å –ø–æ–∑–∂–µ."
            )
        return

    # –õ–∏–º–∏—Ç —É—Ç–æ—á–Ω—è—é—â–∏—Ö —É–∂–µ –∏—Å—á–µ—Ä–ø–∞–Ω
    if state["last_answer"] and state["followup_count"] >= MAX_FOLLOWUP_QUESTIONS:
        await message.answer(
            "–¢—ã —É–∂–µ –∑–∞–¥–∞–ª 3 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞ –ø–æ —ç—Ç–æ–º—É —Ä–∞—Å—á—ë—Ç—É.\n"
            "–•–æ—á–µ—à—å –Ω–æ–≤—ã–π —Ä–∞–∑–±–æ—Ä? –û—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É—é –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è (–î–î.–ú–ú.–ì–ì–ì–ì)."
        )
        return

    # –í–æ–æ–±—â–µ –Ω–∏ –¥–∞—Ç—ã, –Ω–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ä–∞–∑–±–æ—Ä–∞
    await message.answer(
        "–Ø –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä, –Ω–æ –Ω–µ —ç–∫—Å—Ç—Ä–∞—Å–µ–Ω—Å ‚Äî –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è —è —Ç–∞–∫ –Ω–µ –ø–æ–π–º—É üòä\n"
        "–ù–∞–ø–∏—à–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì, –Ω–∞–ø—Ä–∏–º–µ—Ä: 07.09.1990\n"
        "–î–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞ –Ω–∞ 2026: ¬´–ø—Ä–æ–≥–Ω–æ–∑ 07.09.1990¬ª"
    )

# -------- –ó–ê–ü–£–°–ö --------

async def main():
    logger.info("–ë–æ—Ç –ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä –ê–ª—å–≤–∞—Å–∞—Ä–∏—É—Å –∑–∞–ø—É—â–µ–Ω.")
    await dp.start_polling(bot, allowed_updates=["message"])


if __name__ == "__main__":
    asyncio.run(main())



