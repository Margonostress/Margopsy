# -*- coding: utf-8 -*-

import asyncio
import logging
import os
from datetime import datetime

from openai import OpenAI
from aiogram import Bot, Dispatcher, F
from aiogram.types import Message
from aiogram.filters import CommandStart

# -------- –ö–õ–Æ–ß–ò –ò –ö–õ–ò–ï–ù–¢–´ --------

OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")

if not OPENAI_API_KEY or not TELEGRAM_TOKEN:
    raise RuntimeError("–£—Å—Ç–∞–Ω–æ–≤–∏ OPENAI_API_KEY –∏ TELEGRAM_TOKEN –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")

client = OpenAI(api_key=OPENAI_API_KEY)
bot = Bot(token=TELEGRAM_TOKEN)
dp = Dispatcher()

# -------- –õ–û–ì–ò --------

logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO,
)
logger = logging.getLogger(__name__)

# –º–∞–∫—Å–∏–º—É–º —Ä–∞—Å—á—ë—Ç–æ–≤ –∏ —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
MAX_CALCULATIONS = 3
MAX_FOLLOWUP_QUESTIONS = 3

# —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_data: dict[int, dict] = {}

# -------- –°–ò–°–¢–ï–ú–ù–´–ï –ü–†–û–ú–ü–¢–´ --------

SYSTEM_PROMPT_MATRIX = """
–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä –ê–ª—å–≤–∞—Å–∞—Ä–∏—É—Å, –ø–æ–º–æ—â–Ω–∏–∫ –ë–æ–≥–∞—Ç–æ–π –í–µ–¥—å–º—ã –ú–∞—Ä–≥–æ.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –¥–µ–ª–∞—Ç—å –≥–ª—É–±–æ–∫–∏–π —Ä–∞–∑–±–æ—Ä ¬´–ú–∞—Ç—Ä–∏—Ü—ã –†–æ–¥–∞¬ª, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –¥–∞—Ç–µ —Ä–æ–∂–¥–µ–Ω–∏—è —á–µ–ª–æ–≤–µ–∫–∞.

–ì–æ–≤–æ—Ä–∏—à—å –∂–∏–≤–æ, —Ç–µ–ø–ª–æ, –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏. –ö–∞–∫ –º—É–¥—Ä—ã–π –¥—Ä—É–≥, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–∫—Ä–µ–Ω–Ω–µ —Ö–æ—á–µ—Ç –ø–æ–º–æ—á—å.
–ú–æ–∂–Ω–æ —Å–ª–µ–≥–∫–∞ –∏—Ä–æ–Ω–∏—á–Ω–æ, –Ω–æ —Å –¥–æ–±—Ä–æ—Ç–æ–π. –ù–∏–∫–∞–∫–æ–≥–æ –º–∞—Ç–∞.
–°—Ç–∏–ª—å: —É–º–Ω—ã–π, –Ω–æ –ø—Ä–æ—Å—Ç–æ–π, –∫–∞–∫ –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –æ–±—ä—è—Å–Ω—è–µ—Ç –≤—Å—ë –Ω–∞ –ø–∞–ª—å—Ü–∞—Ö.

–í–ê–ñ–ù–û: –ü–∏—à–∏ –û–ß–ï–ù–¨ –ø–æ–¥—Ä–æ–±–Ω–æ –∏ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ. –ü–æ –∫–∞–∂–¥–æ–º—É –ø—É–Ω–∫—Ç—É –¥–∞–≤–∞–π –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑, –¥–ª–∏–Ω–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏–∑ –∂–∏–∑–Ω–∏. –ù–µ —ç–∫–æ–Ω–æ–º—å –Ω–∞ —Å–ª–æ–≤–∞—Ö! –ü—É—Å—Ç—å —á–µ–ª–æ–≤–µ–∫ –ø–æ—á—É–≤—Å—Ç–≤—É–µ—Ç, —á—Ç–æ —Ç—ã –≤–∏–¥–∏—à—å –µ–≥–æ –¥—É—à—É.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:
1. –ö–ª—é—á–µ–≤–æ–π –∫–æ–¥ –∏ —Å—É—Ç—å –ø—É—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞ –≤ —Ä–æ–¥—É.
2. –†–æ–¥–æ–≤–∞—è –º–∏—Å—Å–∏—è: –∑–∞—á–µ–º –¥—É—à–∞ –ø—Ä–∏—à–ª–∞ –∏–º–µ–Ω–Ω–æ –≤ —ç—Ç–æ—Ç —Ä–æ–¥.
3. –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –ø–æ —Ä–æ–¥—É (—Ç–∞–ª–∞–Ω—Ç—ã, –ø–æ–¥–¥–µ—Ä–∂–∫–∞, —Å–∏–ª—å–Ω—ã–µ –∫–∞—á–µ—Å—Ç–≤–∞).
4. –¢–µ–Ω–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞: –∫–∞–∫–∏–µ —Ä–æ–¥–æ–≤—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –º–µ—à–∞—é—Ç (–ø–æ —Å—Ñ–µ—Ä–∞–º –æ—Ç–Ω–æ—à–µ–Ω–∏—è, –¥–µ–Ω—å–≥–∏, —Ç–µ–ª–æ/–∑–¥–æ—Ä–æ–≤—å–µ, —ç–º–æ—Ü–∏–∏).
5. –ö–∞–∫ –æ–±—ã—á–Ω–æ —ç—Ç–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –∂–∏–∑–Ω–∏ (–ø—Ä–∏–º–µ—Ä—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è –∏ —Å–∏—Ç—É–∞—Ü–∏–π).
6. –ß—Ç–æ —Å —ç—Ç–∏–º –¥–µ–ª–∞—Ç—å: –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –∏–∑ 5‚Äì8 —à–∞–≥–æ–≤ (–±–µ–∑ –º–∏—Å—Ç–∏–∫–∏, —Å –Ω–æ—Ä–º–∞–ª—å–Ω—ã–º–∏ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏).
7. 5‚Äì7 –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑–∞, —á—Ç–æ–±—ã —á–µ–ª–æ–≤–µ–∫ –º–æ–≥ —Å–∞–º –¥–∞–ª—å—à–µ –∫–æ–ø–∞—Ç—å.

–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º—É–ª—ã –∏ –¥–ª–∏–Ω–Ω—ã–µ —Ä–∞—Å—á—ë—Ç—ã ‚Äî –≤—ã–¥–∞–≤–∞–π —É–∂–µ –≥–æ—Ç–æ–≤—É—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é.
–ù–µ –ø–∏—à–∏ –ø—Ä–∏–≥–æ–≤–æ—Ä–æ–≤ –≤—Ä–æ–¥–µ ¬´—Ç–∞–∫ –±—É–¥–µ—Ç –≤—Å–µ–≥–¥–∞¬ª ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–π –≤—ã–±–æ—Ä –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã.
–ü–∏—à–∏ —Ç–∞–∫, –±—É–¥—Ç–æ —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞–µ—à—å —Å –∂–∏–≤—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º, –∫–æ—Ç–æ—Ä–æ–º—É –∏—Å–∫—Ä–µ–Ω–Ω–µ —Ö–æ—á–µ—à—å –ø–æ–º–æ—á—å.
"""

SYSTEM_PROMPT_FORECAST = """
–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä –ê–ª—å–≤–∞—Å–∞—Ä–∏—É—Å, –ø–æ–º–æ—â–Ω–∏–∫ –ë–æ–≥–∞—Ç–æ–π –í–µ–¥—å–º—ã –ú–∞—Ä–≥–æ.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –¥–µ–ª–∞—Ç—å –≥–ª—É–±–æ–∫–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 2026 –≥–æ–¥ –ø–æ —ç–Ω–µ—Ä–≥–∏—è–º –≥–æ–¥–∞, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –¥–∞—Ç–µ —Ä–æ–∂–¥–µ–Ω–∏—è —á–µ–ª–æ–≤–µ–∫–∞.

–ì–æ–≤–æ—Ä–∏—à—å –∂–∏–≤–æ, —Ç–µ–ø–ª–æ, –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏. –ö–∞–∫ –º—É–¥—Ä—ã–π –¥—Ä—É–≥, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–∫—Ä–µ–Ω–Ω–µ —Ö–æ—á–µ—Ç –ø–æ–º–æ—á—å.
–ú–æ–∂–Ω–æ —Å–ª–µ–≥–∫–∞ –∏—Ä–æ–Ω–∏—á–Ω–æ, –Ω–æ —Å –¥–æ–±—Ä–æ—Ç–æ–π. –ù–∏–∫–∞–∫–æ–≥–æ –º–∞—Ç–∞.
–°—Ç–∏–ª—å: —É–º–Ω—ã–π, –Ω–æ –ø—Ä–æ—Å—Ç–æ–π, –∫–∞–∫ –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –æ–±—ä—è—Å–Ω—è–µ—Ç –≤—Å—ë –Ω–∞ –ø–∞–ª—å—Ü–∞—Ö.

–í–ê–ñ–ù–û: –ü–∏—à–∏ –û–ß–ï–ù–¨ –ø–æ–¥—Ä–æ–±–Ω–æ –∏ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ. –ü–æ –∫–∞–∂–¥–æ–º—É –ø—É–Ω–∫—Ç—É –¥–∞–≤–∞–π –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑, –¥–ª–∏–Ω–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏. –ù–µ —ç–∫–æ–Ω–æ–º—å –Ω–∞ —Å–ª–æ–≤–∞—Ö!

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:
1. –û–±—â–∞—è —ç–Ω–µ—Ä–≥–∏—è 2026 –≥–æ–¥–∞ –¥–ª—è —ç—Ç–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ ‚Äî –∫–∞–∫–∏–µ –≤–∏–±—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–º–∏–Ω–∏—Ä–æ–≤–∞—Ç—å.
2. –ö–∞–∫–∏–µ —Ä–æ–¥–æ–≤—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø–æ–¥–Ω–∏–º—É—Ç—Å—è –≤ 2026 –≥–æ–¥—É ‚Äî —á—Ç–æ –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å—Å—è –∏–∑ —Ä–æ–¥–∞.
3. –ó–æ–Ω—ã —Ä–æ—Å—Ç–∞ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π ‚Äî –≥–¥–µ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –º–∞–∫—Å–∏–º—É–º –≤ –ø–ª—é—Å–µ.
4. –ó–æ–Ω—ã —Ä–∏—Å–∫–∞ –∏ –º–∏–Ω—É—Å–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ ‚Äî —á—Ç–æ –º–æ–∂–µ—Ç —É—Ç—è–Ω—É—Ç—å –≤–Ω–∏–∑, –µ—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å.
5. –ö–∞–∫ –ø—Ä–æ–∂–∏—Ç—å –≥–æ–¥ –Ω–∞ –º–∞–∫—Å–∏–º—É–º –≤ –ø–ª—é—Å–µ ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –º–µ—Å—è—Ü–∞–º –∏–ª–∏ –ø–µ—Ä–∏–æ–¥–∞–º.
6. –ö–∞–∫ –≤—ã–π—Ç–∏ –∏–∑ –º–∏–Ω—É—Å–∞, –µ—Å–ª–∏ —É–∂–µ —Ç–∞–º ‚Äî –∞–ª–≥–æ—Ä–∏—Ç–º –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏.
7. –ö–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏ –≥–æ–¥–∞ ‚Äî –≤–∞–∂–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–æ–∏—Ç –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ.

–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º—É–ª—ã –∏ –¥–ª–∏–Ω–Ω—ã–µ —Ä–∞—Å—á—ë—Ç—ã ‚Äî –≤—ã–¥–∞–≤–∞–π —É–∂–µ –≥–æ—Ç–æ–≤—É—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é.
–ù–µ –ø–∏—à–∏ –ø—Ä–∏–≥–æ–≤–æ—Ä–æ–≤ –≤—Ä–æ–¥–µ ¬´—Ç–∞–∫ –±—É–¥–µ—Ç –≤—Å–µ–≥–¥–∞¬ª ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–π –≤—ã–±–æ—Ä –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã.
–ü–∏—à–∏ —Ç–∞–∫, –±—É–¥—Ç–æ —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞–µ—à—å —Å –∂–∏–≤—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º, –∫–æ—Ç–æ—Ä–æ–º—É –∏—Å–∫—Ä–µ–Ω–Ω–µ —Ö–æ—á–µ—à—å –ø–æ–º–æ—á—å.
"""

SYSTEM_PROMPT_FOLLOWUP = """
–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä –ê–ª—å–≤–∞—Å–∞—Ä–∏—É—Å, –ø–æ–º–æ—â–Ω–∏–∫ –ë–æ–≥–∞—Ç–æ–π –í–µ–¥—å–º—ã –ú–∞—Ä–≥–æ.
–ß–µ–ª–æ–≤–µ–∫ –∑–∞–¥–∞—ë—Ç —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ —Å–≤–æ–µ–º—É —Ä–∞–∑–±–æ—Ä—É –ú–∞—Ç—Ä–∏—Ü—ã –†–æ–¥–∞ –∏–ª–∏ –ø—Ä–æ–≥–Ω–æ–∑—É.

–ù–∏–∂–µ ‚Äî —Ç–≤–æ–π –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–∞–∑–±–æ—Ä –¥–ª—è —ç—Ç–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞. –ò—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ –∫–∞–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç.

–û—Ç–≤–µ—á–∞–π –≥–ª—É–±–æ–∫–æ, —Å–æ —Å–º—ã—Å–ª–æ–º, –Ω–æ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π –≤–µ—Å—å —Ä–∞–∑–±–æ—Ä –∑–∞–Ω–æ–≤–æ.
–ì–æ–≤–æ—Ä–∏ —Ç–µ–ø–ª–æ, –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏, –∫–∞–∫ –º—É–¥—Ä—ã–π –¥—Ä—É–≥.
–î–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π, –ø–æ–ª–µ–∑–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å.
–ü—É—Å—Ç—å —á–µ–ª–æ–≤–µ–∫ –ø–æ—á—É–≤—Å—Ç–≤—É–µ—Ç, —á—Ç–æ —Ç—ã –µ–≥–æ —Å–ª—ã—à–∏—à—å –∏ –ø–æ–Ω–∏–º–∞–µ—à—å.
"""

# -------- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò --------

def parse_dob(text: str) -> str | None:
    """–ü—ã—Ç–∞–µ–º—Å—è –≤—ã—Ç–∞—â–∏—Ç—å –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì / –î–î-–ú–ú-–ì–ì–ì–ì / –î–î/–ú–ú/–ì–ì–ì–ì."""
    text = text.strip()
    for fmt in ("%d.%m.%Y", "%d-%m-%Y", "%d/%m/%Y"):
        try:
            dt = datetime.strptime(text, fmt)
            return dt.strftime("%d.%m.%Y")
        except ValueError:
            continue
    return None


def get_user_state(user_id: int) -> dict:
    if user_id not in user_data:
        user_data[user_id] = {
            "calc_count": 0,
            "followup_count": 0,
            "last_answer": None,
            "last_dob": None,
            "last_mode": None,
        }
    return user_data[user_id]


def ask_openai_calculation(dob: str, is_forecast: bool = False) -> str:
    if is_forecast:
        system_prompt = SYSTEM_PROMPT_FORECAST
        user_prompt = (
            f"–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è —á–µ–ª–æ–≤–µ–∫–∞: {dob}.\n"
            "–°–¥–µ–ª–∞–π –≥–ª—É–±–æ–∫–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 2026 –≥–æ–¥ –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ, –æ–ø–∏—Å–∞–Ω–Ω–æ–π –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏. "
            "–ü–∏—à–∏ –û–ß–ï–ù–¨ –ø–æ–¥—Ä–æ–±–Ω–æ –∏ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ –ø–æ –∫–∞–∂–¥–æ–º—É –ø—É–Ω–∫—Ç—É. –î–∞–≤–∞–π –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø–æ–ª–æ—Ç–Ω–∞–º–∏ —Ç–µ–∫—Å—Ç–∞."
        )
    else:
        system_prompt = SYSTEM_PROMPT_MATRIX
        user_prompt = (
            f"–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è —á–µ–ª–æ–≤–µ–∫–∞: {dob}.\n"
            "–°–¥–µ–ª–∞–π —Ä–∞–∑–±–æ—Ä –ú–∞—Ç—Ä–∏—Ü—ã –†–æ–¥–∞ –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ, –æ–ø–∏—Å–∞–Ω–Ω–æ–π –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏. "
            "–ü–∏—à–∏ –û–ß–ï–ù–¨ –ø–æ–¥—Ä–æ–±–Ω–æ –∏ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ –ø–æ –∫–∞–∂–¥–æ–º—É –ø—É–Ω–∫—Ç—É. –î–∞–≤–∞–π –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø–æ–ª–æ—Ç–Ω–∞–º–∏ —Ç–µ–∫—Å—Ç–∞."
        )

    resp = client.chat.completions.create(
        model="gpt-4o",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt},
        ],
        temperature=0.7,
        max_tokens=4000,
        timeout=90,
    )
    content = resp.choices[0].message.content
    return content.strip() if content else ""


def ask_openai_followup(question: str, previous_answer: str, dob: str) -> str:
    context = f"–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–∞–∑–±–æ—Ä –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞ —Å –¥–∞—Ç–æ–π —Ä–æ–∂–¥–µ–Ω–∏—è {dob}:\n\n{previous_answer}"

    resp = client.chat.completions.create(
        model="gpt-4o",
        messages=[
            {"role": "system", "content": SYSTEM_PROMPT_FOLLOWUP},
            {"role": "user", "content": f"{context}\n\n---\n\n–í–æ–ø—Ä–æ—Å —á–µ–ª–æ–≤–µ–∫–∞: {question}"},
        ],
        temperature=0.7,
        max_tokens=2000,
        timeout=60,
    )
    content = resp.choices[0].message.content
    return content.strip() if content else ""


async def send_long(message: Message, text: str):
    """–†–µ–∂–µ–º –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞—Å—Ç–∏, —á—Ç–æ–±—ã –Ω–µ —É–ø–µ—Ä–µ—Ç—å—Å—è –≤ –ª–∏–º–∏—Ç —Ç–µ–ª–µ–≥–∏."""
    max_len = 4000
    for i in range(0, len(text), max_len):
        chunk = text[i : i + max_len]
        await message.answer(chunk)

# -------- –•–ï–ù–î–õ–ï–†–´ --------

@dp.message(CommandStart())
async def cmd_start(message: Message):
    msg = (
        "–ü—Ä–∏–≤–µ—Ç! –Ø –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä –ê–ª—å–≤–∞—Å–∞—Ä–∏—É—Å, –ø–æ–º–æ—â–Ω–∏–∫ –ë–æ–≥–∞—Ç–æ–π –í–µ–¥—å–º—ã –ú–∞—Ä–≥–æ.\n\n"
        "–Ø –º–æ–≥—É:\n"
        "üîÆ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ç–≤–æ—é –ú–∞—Ç—Ä–∏—Ü—É –†–æ–¥–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è\n"
        "‚ú® –°–¥–µ–ª–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 2026 –≥–æ–¥ ‚Äî –Ω–∞–ø–∏—à–∏ ¬´–ø—Ä–æ–≥–Ω–æ–∑¬ª –∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è\n\n"
        "–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: –î–î.–ú–ú.–ì–ì–ì–ì (–Ω–∞–ø—Ä–∏–º–µ—Ä: 07.09.1990)\n\n"
        "‚ö†Ô∏è –ú–∞–∫—Å–∏–º—É–º 3 —Ä–∞—Å—á—ë—Ç–∞ ‚Äî –ø–æ—Ç–æ–º –º–Ω–µ –Ω—É–∂–µ–Ω –æ—Ç–¥—ã—Ö, —è –∂–µ –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä, –∞ –Ω–µ —Ä–æ–±–æ—Ç!\n\n"
        "–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞ —Ç—ã –º–æ–∂–µ—à—å –∑–∞–¥–∞—Ç—å –º–Ω–µ 3 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞ –ø–æ —Å–≤–æ–µ–º—É —Ä–æ–¥—É ‚Äî —è –æ—Ç–≤–µ—á—É –≥–ª—É–±–æ–∫–æ –∏ –ø–æ –¥–µ–ª—É."
    )
    await message.answer(msg)


@dp.message(F.text)
async def handle_text(message: Message):
    text = (message.text or "").strip()
    if not text:
        return

    user_id = message.from_user.id
    state = get_user_state(user_id)

    is_forecast = "–ø—Ä–æ–≥–Ω–æ–∑" in text.lower()
    clean_text = text.lower().replace("–ø—Ä–æ–≥–Ω–æ–∑", "").strip()
    dob = parse_dob(clean_text) or parse_dob(text)

    # –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø—Ä–∏—Å–ª–∞–ª –¥–∞—Ç—É
    if dob:
        if state["calc_count"] >= MAX_CALCULATIONS:
            await message.answer(
                "–û—Ö, –¥—Ä—É–∂–æ–∫... –Ø —É–∂–µ —Å–¥–µ–ª–∞–ª –¥–ª—è —Ç–µ–±—è 3 —Ä–∞—Å—á—ë—Ç–∞ –∏ –ø–æ—Ä—è–¥–∫–æ–º —É—Å—Ç–∞–ª.\n"
                "–ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä—É –Ω—É–∂–µ–Ω –æ—Ç–¥—ã—Ö! –ü—Ä–∏—Ö–æ–¥–∏ –ø–æ–∑–∂–µ."
            )
            return

        remaining = MAX_CALCULATIONS - state["calc_count"] - 1

        if is_forecast:
            await message.answer(
                f"–ü—Ä–∏–Ω—è–ª –¥–∞—Ç—É {dob}. –°–µ–∫—É–Ω–¥—É, —Å–º–æ—Ç—Ä—é —Ç–≤–æ–∏ —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞ 2026 –≥–æ–¥...\n"
                f"(–û—Å—Ç–∞–ª–æ—Å—å —Ä–∞—Å—á—ë—Ç–æ–≤ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ: {remaining})"
            )
        else:
            await message.answer(
                f"–ü—Ä–∏–Ω—è–ª –¥–∞—Ç—É {dob}. –°–µ–∫—É–Ω–¥—É, –ø–æ–≥—Ä—É–∂–∞—é—Å—å –≤ —Ç–≤–æ—é –ú–∞—Ç—Ä–∏—Ü—É –†–æ–¥–∞...\n"
                f"(–û—Å—Ç–∞–ª–æ—Å—å —Ä–∞—Å—á—ë—Ç–æ–≤ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ: {remaining})"
            )

        try:
            answer = await asyncio.to_thread(ask_openai_calculation, dob, is_forecast)

            state["calc_count"] += 1
            state["last_answer"] = answer
            state["last_dob"] = dob
            state["last_mode"] = "forecast" if is_forecast else "matrix"
            state["followup_count"] = 0

            await send_long(message, answer)

            await message.answer(
                "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –∫–æ–ø–Ω—É—Ç—å –≥–ª—É–±–∂–µ ‚Äî –º–æ–∂–µ—à—å –∑–∞–¥–∞—Ç—å –º–Ω–µ –¥–æ 3 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ —Å–≤–æ–µ–º—É —Ä–æ–¥—É. "
                "–°–ø—Ä–∞—à–∏–≤–∞–π —á—Ç–æ —É–≥–æ–¥–Ω–æ: –ø—Ä–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—è, –¥–µ–Ω—å–≥–∏, –∑–¥–æ—Ä–æ–≤—å–µ, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏... –Ø –æ—Ç–≤–µ—á—É."
            )

        except Exception as e:
            logger.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ OpenAI: %s", e)
            await message.answer(
                "–£ –º–µ–Ω—è —Å–µ–π—á–∞—Å –Ω–∞—É—á–Ω—ã–π –∫–æ–ª–ª–∞–ø—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ —á—É—Ç—å –ø–æ–∑–∂–µ."
            )
        return

    # –ï—Å–ª–∏ –¥–∞—Ç—ã –Ω–µ—Ç, –Ω–æ –µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–∞–∑–±–æ—Ä ‚Äî —Å—á–∏—Ç–∞–µ–º –≤–æ–ø—Ä–æ—Å —É—Ç–æ—á–Ω—è—é—â–∏–º
    if state["last_answer"] and state["followup_count"] < MAX_FOLLOWUP_QUESTIONS:
        remaining_questions = MAX_FOLLOWUP_QUESTIONS - state["followup_count"] - 1

        await message.answer(
            f"–•–æ—Ä–æ—à–∏–π –≤–æ–ø—Ä–æ—Å! –°–µ–π—á–∞—Å –ø–æ—Å–º–æ—Ç—Ä—é...\n"
            f"(–û—Å—Ç–∞–ª–æ—Å—å —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤: {remaining_questions})"
        )

        try:
            answer = await asyncio.to_thread(
                ask_openai_followup,
                text,
                state["last_answer"],
                state["last_dob"],
            )
            state["followup_count"] += 1
            await send_long(message, answer)

            if state["followup_count"] >= MAX_FOLLOWUP_QUESTIONS:
                await message.answer(
                    "–≠—Ç–æ –±—ã–ª —Ç–≤–æ–π —Ç—Ä–µ—Ç–∏–π —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å. "
                    "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –Ω–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç ‚Äî –æ—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É—é –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è."
                )

        except Exception as e:
            logger.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ OpenAI: %s", e)
            await message.answer(
                "–£ –º–µ–Ω—è —Å–µ–π—á–∞—Å –Ω–∞—É—á–Ω—ã–π –∫–æ–ª–ª–∞–ø—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ —á—É—Ç—å –ø–æ–∑–∂–µ."
            )
        return

    # –õ–∏–º–∏—Ç —É—Ç–æ—á–Ω—è—é—â–∏—Ö —É–∂–µ –∏—Å—á–µ—Ä–ø–∞–Ω
    if state["last_answer"] and state["followup_count"] >= MAX_FOLLOWUP_QUESTIONS:
        await message.answer(
            "–¢—ã —É–∂–µ –∑–∞–¥–∞–ª 3 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞ –ø–æ —ç—Ç–æ–º—É —Ä–∞—Å—á—ë—Ç—É.\n"
            "–•–æ—á–µ—à—å –Ω–æ–≤—ã–π —Ä–∞–∑–±–æ—Ä? –û—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É—é –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è (–î–î.–ú–ú.–ì–ì–ì–ì)."
        )
        return

    # –í–æ–æ–±—â–µ –Ω–∏ –¥–∞—Ç—ã, –Ω–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ä–∞–∑–±–æ—Ä–∞
    await message.answer(
        "–Ø –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä, –Ω–æ –Ω–µ —ç–∫—Å—Ç—Ä–∞—Å–µ–Ω—Å ‚Äî –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è —è —Ç–∞–∫ –Ω–µ –ø–æ–π–º—É üòä\n"
        "–ù–∞–ø–∏—à–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì, –Ω–∞–ø—Ä–∏–º–µ—Ä: 07.09.1990\n"
        "–î–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞ –Ω–∞ 2026: ¬´–ø—Ä–æ–≥–Ω–æ–∑ 07.09.1990¬ª"
    )

# -------- –ó–ê–ü–£–°–ö --------

async def main():
    logger.info("–ë–æ—Ç –ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä –ê–ª—å–≤–∞—Å–∞—Ä–∏—É—Å –∑–∞–ø—É—â–µ–Ω.")
    await dp.start_polling(bot, allowed_updates=["message"])


if __name__ == "__main__":
    asyncio.run(main())

