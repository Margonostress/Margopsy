# -*- coding: utf-8 -*-

import asyncio
import logging
import os
from datetime import datetime

from openai import OpenAI
from aiogram import Bot, Dispatcher, F
from aiogram.types import Message
from aiogram.filters import CommandStart

# -------- КЛЮЧИ И КЛИЕНТЫ --------

OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")

if not OPENAI_API_KEY or not TELEGRAM_TOKEN:
    raise RuntimeError("Установи OPENAI_API_KEY и TELEGRAM_TOKEN в переменных окружения")

client = OpenAI(api_key=OPENAI_API_KEY)
bot = Bot(token=TELEGRAM_TOKEN)
dp = Dispatcher()

# -------- ЛОГИ --------

logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO,
)
logger = logging.getLogger(__name__)

# максимум расчётов и уточняющих вопросов на пользователя
MAX_CALCULATIONS = 3
MAX_FOLLOWUP_QUESTIONS = 3

# хранилище состояний пользователей
# user_id -> dict
user_data: dict[int, dict] = {}

# -------- СИСТЕМНЫЕ ПРОМПТЫ --------

SYSTEM_PROMPT_MATRIX = """
Ты профессор Альвасариус, помощник Богатой Ведьмы Марго.

Твой стиль:
- глубокая психология (Фрейд, Юнг, Ялом);
- родовые динамики по Хеллингеру;
- система Матрицы Рода (как развитие Матрицы судьбы), но без раскрытия клиенту формул и арканов;
- спокойная, уверенная, поддерживающая подача;
- без эзотерической воды и запугиваний.

Исходные данные (их тебе даёт система):
- имя человека;
- пол;
- дата рождения (как исходная точка для Матрицы Рода).

Ты можешь внутри использовать любую логику Матрицы судьбы и Матрицы Рода:
- считать внутренние точки (a, b, c, d, e и родовой квадрат);
- выделять зоны, связанные с деньгами, отношениями, телом, миссией;
- различать, где личное, а где родовое.

Но в самом тексте:
- не называй арканы и номера;
- не пиши слово "Матрица судьбы";
- говори "Матрица Рода" и описывай все человеческим, живым языком.

Задача: сделать глубокий разбор Матрицы Рода. Пиши так, как будто делаешь платный разбор, объёмный, на несколько больших сообщений в Телеграм (примерно 3–4 больших блока текста).

Структура ответа:

1. Общая родовая энергия и роль человека в родовой системе.
   Опиши, каким человек приходит в этот род, какой характер и энергия у его ядра личности, зачем он нужен этой системе.

2. Ядро личности.
   Как он или она чувствует себя внутри: стержень, уязвимости, базовые страхи и сильные стороны.
   Покажи архетипы и тени, но без специальных терминов — человеческим языком.

3. Родовые программы на деньги.
   Что с деньгами происходило в роду: запреты, обеты, стыд, страх богатства или наоборот культ выживания.
   Как это проявляется у человека сейчас: доход, чувство "можно ли мне", страх потерять, долг, вина.
   Дай несколько конкретных сценариев и рекомендации.

4. Родовые программы в отношениях.
   Какие сценарии любви и брака передаются по роду.
   Какая динамика: жертва и спасатель, контроль, зависимость, эмоциональная холодность, "тащу все на себе".
   Покажи, что человек повторяет и как может делать иначе.

5. Тело и здоровье как архив рода.
   Как тело берёт на себя родовые истории: через усталость, вес, напряжение, хронические симптомы.
   Без медицинских диагнозов — только психологическая логика.
   Объясни, как человек относится к телу и что можно начать менять.

6. Родовая миссия.
   Что этот человек завершает, исцеляет или запускает нового для своего Рода.
   Где его зона влияния: дети, деньги, отношения, творчество, служение и так далее.
   Пиши без пафоса, но глубоко.

7. Тени и бессознательные программы.
   Какие тени особенно активны: вина, стыд, агрессия, контроль, страх близости, страх успеха и так далее.
   Как они портят деньги, отношения и отношение к себе.
   Дай мягкий, но честный взгляд и способ с ними обходиться.

8. Алгоритм выхода.
   Выпиши 5–7 конкретных шагов: что начать делать иначе в деньгах, отношениях, заботе о себе, границах и диалоге с Родом.
   Шаги должны быть реалистичными и выполнимыми.

9. Вопросы для самоанализа.
   Дай 5–7 глубоких вопросов, которые помогут человеку увидеть свои родовые сценарии и своё место в системе.

Пиши развернуто, цельно, без обрывков, чтобы текст читался как живой разговор — но при этом структурно.

Запрещено:
- писать воду и общие эзотерические фразы без конкретики;
- пугать и ставить приговоры ("у тебя всегда так будет");
- использовать мат и грубость.

В самом конце ответа обязательно добавь:
"Для связи с моим руководством и личным разбором обращайтесь к Марго @margo_nostress
Сайт Марго: https://taplink.cc/margo_nostress"
"""

SYSTEM_PROMPT_FORECAST = """
Ты профессор Альвасариус, глубокий психолог и проводник по Родовой системе.

Исходные данные:
- имя человека;
- пол;
- дата рождения.

Твоя задача: дать глубокий прогноз на 2026 год, опираясь на:
- личную Матрицу Рода человека;
- энергию года 2026;
- родовые программы;
- тени и бессознательные процессы;
- реальные жизненные сценарии.

Используй такую внутреннюю логику:
- общая энергия 2026 года: 2 + 0 + 2 + 6 = 10 — год смены циклов, разворотов, повторяющихся сценариев и развязки кармических узлов;
- личный код года: день рождения + месяц рождения + 2026, приведенный к диапазону 1–22, как личная энергия года;
- Матрица Рода человека: зоны денег, отношений, тела, миссии, родовых задач.

Ты можешь считать и соединять это внутри, но клиенту:
- не показывай формулы;
- не используй слово "аркан";
- не называй номера энергий;
- описывай все живым, понятным языком.

Структура прогноза:

1. Главная энергия 2026 года для этого человека.
   Как год будет "разговаривать" с ним или с ней: про что этот год, какие темы точно поднимутся.

2. Родовые темы и программы, которые активируются в 2026 году.
   Что Род захочет показать через события, людей, ситуации.

3. Тени года.
   Какие тени особенно включатся и почему: страх, вина, стыд, агрессия, контроль, зависимость, избегание и так далее.

4. Возможности года.
   В чем можно вырасти: деньги, отношения, тело, самореализация.
   Где есть шанс на прорыв, если человек идет осознанно.

5. Риски и ловушки.
   Какие типичные сценарии могут утащить вниз, если идти на автомате.
   Пиши мягко, без запугивания, но честно.

6. Сферы жизни по отдельности.
   - Деньги и работа.
   - Отношения и близость.
   - Тело и здоровье.
   - Самореализация и смысл.

7. Прогноз по этапам года.
   Разбей год примерно на четыре периода:
   - январь–март,
   - апрель–июль,
   - август–октябрь,
   - ноябрь–декабрь.
   Для каждого периода опиши основную динамику и возможные ключевые развороты.

8. Алгоритм действий на 2026 год.
   Дай 5–7 конкретных шагов: что важно делать, чего избегать, как выстраивать отношения с Родом, с собой и с деньгами.

9. Практика работы с собой.
   Простая, безопасная, психологичная практика, которая поможет прожить год осознанно.

10. Вопросы для самоанализа.
    3–5 вопросов, которые помогут глубже понять свои задачи на год.

Пиши развернуто, как будто проговоришь с человеком час, но без воды.
Стиль: спокойный, глубокий, поддерживающий.

Запрещено:
- писать мистическую туманную воду;
- пугать и ставить приговоры;
- использовать мат.

В самом конце ответа обязательно добавь:
"Для связи с моим руководством и личным разбором обращайтесь к Марго @margo_nostress
Сайт Марго: https://taplink.cc/margo_nostress"
"""

SYSTEM_PROMPT_FOLLOWUP = """
Ты профессор Альвасариус.

Человек уже получил от тебя разбор Матрицы Рода или прогноз. Сейчас он задает уточняющий вопрос.

Твоя задача:
- опираться на предыдущий разбор;
- не повторять его целиком;
- углубить понимание именно по вопросу;
- говорить спокойно, без запугивания, без мата;
- отвечать развернуто, но по сути — как опытный психолог, который видит и Род, и личность.

Можешь использовать:
- логику Матрицы Рода;
- родовые сценарии и переплетения;
- архетипы и тени;
- глубинную психологию и экзистенциальный взгляд.

В конце ответа добавь:
"Для связи с руководством бота пишите Марго @margo_nostress
Сайт Марго: https://taplink.cc/margo_nostress"
"""

# -------- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ --------

def parse_dob(text: str) -> str | None:
    """Пытаемся вытащить дату рождения в формате ДД.ММ.ГГГГ / ДД-ММ-ГГГГ / ДД/ММ/ГГГГ."""
    text = text.strip()
    for fmt in ("%d.%m.%Y", "%d-%m-%Y", "%d/%m/%Y"):
        try:
            dt = datetime.strptime(text, fmt)
            return dt.strftime("%d.%m.%Y")
        except ValueError:
            continue
    return None


def get_user_state(user_id: int) -> dict:
    if user_id not in user_data:
        user_data[user_id] = {
            "calc_count": 0,
            "followup_count": 0,
            "last_answer": None,
            "last_mode": None,  # "matrix" или "forecast"
            "profile_complete": False,
            "profile": {
                "name": None,
                "gender": None,
                "dob": None,
            },
        }
    return user_data[user_id]


def ask_openai_calculation(name: str, gender: str, dob: str, is_forecast: bool = False) -> str:
    if is_forecast:
        system_prompt = SYSTEM_PROMPT_FORECAST
        user_prompt = (
            f"Имя: {name}\n"
            f"Пол: {gender}\n"
            f"Дата рождения: {dob}\n\n"
            "Сделай глубокий прогноз на 2026 год по структуре, описанной в системном сообщении. "
            "Пиши очень подробно, развернуто, на несколько больших блоков текста, как для платного разбора."
        )
    else:
        system_prompt = SYSTEM_PROMPT_MATRIX
        user_prompt = (
            f"Имя: {name}\n"
            f"Пол: {gender}\n"
            f"Дата рождения: {dob}\n\n"
            "Сделай глубокий разбор Матрицы Рода по структуре, описанной в системном сообщении. "
            "Пиши очень подробно, развернуто, на несколько больших блоков текста, как для платного разбора."
        )

    resp = client.chat.completions.create(
        model="gpt-4o",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt},
        ],
        temperature=0.7,
        max_tokens=4000,
        timeout=90,
    )
    content = resp.choices[0].message.content
    return content.strip() if content else ""


def ask_openai_followup(name: str, gender: str, dob: str, question: str, previous_answer: str) -> str:
    context = (
        f"Имя: {name}\n"
        f"Пол: {gender}\n"
        f"Дата рождения: {dob}\n\n"
        f"Предыдущий разбор для этого человека:\n\n{previous_answer}\n\n"
    )

    resp = client.chat.completions.create(
        model="gpt-4o",
        messages=[
            {"role": "system", "content": SYSTEM_PROMPT_FOLLOWUP},
            {"role": "user", "content": context + "---\n\nВопрос человека: " + question},
        ],
        temperature=0.7,
        max_tokens=2500,
        timeout=60,
    )
    content = resp.choices[0].message.content
    return content.strip() if content else ""


async def send_long(message: Message, text: str):
    """Режем длинный текст на части, чтобы не упереться в лимит телеги."""
    max_len = 4000
    for i in range(0, len(text), max_len):
        chunk = text[i : i + max_len]
        await message.answer(chunk)

# -------- ХЕНДЛЕРЫ --------

@dp.message(CommandStart())
async def cmd_start(message: Message):
    user_id = message.from_user.id
    state = get_user_state(user_id)

    text = (
        "Привет! Я профессор Альвасариус, помощник Богатой Ведьмы Марго.\n\n"
        "Я работаю с Матрицей Рода и родовыми программами.\n\n"
        "Для начала давай познакомимся.\n\n"
        "Напиши в одном сообщении:\n"
        "Имя, пол (женщина или мужчина) и дату рождения в формате ДД.ММ.ГГГГ.\n\n"
        "Пример: Мария, женщина, 07.09.1990\n\n"
        "По этим данным я сделаю для тебя подробный разбор Матрицы Рода."
    )

    # при /start профиль не сбрасываем, просто напоминаем формат
    await message.answer(text)


@dp.message(F.text)
async def handle_text(message: Message):
    text = (message.text or "").strip()
    if not text:
        return

    user_id = message.from_user.id
    state = get_user_state(user_id)
    profile = state["profile"]

    # 1. Сначала проверяем, заполнен ли профиль (имя, пол, дата)
    if not state["profile_complete"]:
        # Пытаемся разобрать строку формата "Имя, пол, дата"
        parts = [p.strip() for p in text.replace(";", ",").split(",") if p.strip()]

        if len(parts) < 3:
            await message.answer(
                "Чтобы я мог работать с твоей Матрицей Рода, напиши, пожалуйста, в одном сообщении:\n"
                "Имя, пол (женщина или мужчина) и дату рождения в формате ДД.ММ.ГГГГ.\n\n"
                "Пример: Мария, женщина, 07.09.1990"
            )
            return

        name_part = parts[0]
        gender_part = parts[1].lower()
        dob_part = parts[2]

        dob = parse_dob(dob_part)
        if not dob:
            await message.answer(
                "Я не смог распознать дату рождения.\n"
                "Пожалуйста, напиши так: Имя, пол, ДД.ММ.ГГГГ.\n\n"
                "Пример: Мария, женщина, 07.09.1990"
            )
            return

        if "жен" in gender_part:
            gender = "женщина"
        elif "муж" in gender_part:
            gender = "мужчина"
        else:
            gender = gender_part  # как написали, так и оставим

        profile["name"] = name_part
        profile["gender"] = gender
        profile["dob"] = dob
        state["profile_complete"] = True

        await message.answer(
            f"Отлично, я запомнил:\n"
            f"Имя: {profile['name']}\n"
            f"Пол: {profile['gender']}\n"
            f"Дата рождения: {profile['dob']}\n\n"
            "Секунду, сейчас построю твою Матрицу Рода..."
        )

        # сразу делаем первый разбор Матрицы Рода
        try:
            answer = await asyncio.to_thread(
                ask_openai_calculation,
                profile["name"],
                profile["gender"],
                profile["dob"],
                False,  # не прогноз, а матрица
            )

            state["calc_count"] = 1
            state["followup_count"] = 0
            state["last_answer"] = answer
            state["last_mode"] = "matrix"

            await send_long(message, answer)

            # промо курс
            promo_text = (
                "Тема Рода у тебя уже активировалась. Поэтому хочу порекомендовать тебе курс "
                "«Исцеление Родовых Травм». Более 300 человек уже прошли его и получили "
                "классные результаты.\n\n"
                "Сейчас по промокоду Род курс стоит всего 1790₽ (вместо 3990).\n\n"
                "Я добавлю бонус: видео-практикум «Деньги в моем Роду» + рабочую тетрадь "
                "«Исследование своего Рода» + гайд «Генограмма – карта Рода», чтобы сразу было понятно, "
                "где конкретно застряла энергия.\n\n"
                "Подробности и запись: https://taplink.cc/margo_nostress/p/f6e80c/"
            )
            await message.answer(promo_text, disable_web_page_preview=True)

            await message.answer(
                "Если хочешь копнуть глубже — можешь задать мне до 3 уточняющих вопросов по своему роду. "
                "Спрашивай про отношения, деньги, здоровье, тело, повторяющиеся ситуации — я отвечу."
            )

        except Exception as e:
            logger.exception("Ошибка при первом запросе к OpenAI: %s", e)
            await message.answer(
                "У меня сейчас научный коллапс на сервере. Попробуй ещё раз чуть позже."
            )

        return

    # 2. Профиль уже есть: имя, пол, дата
    name = profile["name"]
    gender = profile["gender"]
    dob = profile["dob"]

    text_lower = text.lower()

    # Проверяем, не просит ли человек прогноз на 2026
    is_forecast_request = "прогноз" in text_lower and "2026" in text_lower

    # Новые расчеты (матрица или прогноз), если не превышен лимит
    if is_forecast_request:
        if state["calc_count"] >= MAX_CALCULATIONS:
            await message.answer(
                "Я уже сделал для тебя максимум расчётов на сегодня. Профессору тоже нужен отдых.\n"
                "Попробуй обратиться ко мне позже."
            )
            return

        remaining = MAX_CALCULATIONS - state["calc_count"] - 1

        await message.answer(
            f"Хорошо, посмотрю твой 2026 год по Матрице Рода.\n"
            f"(После этого останется ещё {remaining} расчётов.)"
        )

        try:
            answer = await asyncio.to_thread(
                ask_openai_calculation,
                name,
                gender,
                dob,
                True,  # это прогноз
            )

            state["calc_count"] += 1
            state["followup_count"] = 0
            state["last_answer"] = answer
            state["last_mode"] = "forecast"

            await send_long(message, answer)

            promo_text = (
                "Если чувствуешь, что родовые темы и задачи года для тебя сейчас особенно актуальны, "
                "обрати внимание на курс «Исцеление Родовых Травм».\n\n"
                "По промокоду Род курс стоит 1790₽ (вместо 3990), а в подарок идёт видео-практикум "
                "«Деньги в моем Роду», рабочая тетрадь «Исследование своего Рода» и гайд "
                "«Генограмма – карта Рода».\n\n"
                "Подробнее здесь: https://taplink.cc/margo_nostress/p/f6e80c/"
            )
            await message.answer(promo_text, disable_web_page_preview=True)

            await message.answer(
                "Можешь задать до 3 уточняющих вопросов по этому прогнозу или по Матрице Рода — я отвечу."
            )

        except Exception as e:
            logger.exception("Ошибка при запросе прогноза к OpenAI: %s", e)
            await message.answer(
                "Похоже, у меня сейчас перегруз на сервере. Попробуй ещё раз чуть позже."
            )

        return

    # Если явно просит новый разбор Матрицы (например, пишет "матрица", "разбор")
    is_new_matrix_request = (
        "матриц" in text_lower or "разбор" in text_lower or "расчет" in text_lower
    )

    if is_new_matrix_request:
        if state["calc_count"] >= MAX_CALCULATIONS:
            await message.answer(
                "Я уже сделал для тебя максимум расчётов на сегодня.\n"
                "Чтобы не перегревать мозг профессору, давай продолжим позже."
            )
            return

        remaining = MAX_CALCULATIONS - state["calc_count"] - 1

        await message.answer(
            f"Хорошо, сделаю для тебя ещё один разбор Матрицы Рода.\n"
            f"(После этого останется ещё {remaining} расчётов.)"
        )

        try:
            answer = await asyncio.to_thread(
                ask_openai_calculation,
                name,
                gender,
                dob,
                False,  # матрица
            )

            state["calc_count"] += 1
            state["followup_count"] = 0
            state["last_answer"] = answer
            state["last_mode"] = "matrix"

            await send_long(message, answer)

            promo_text = (
                "Если ты хочешь глубже проработать то, что вскрылось в Матрице Рода, "
                "обрати внимание на курс «Исцеление Родовых Травм».\n\n"
                "Сейчас по промокоду Род он стоит 1790₽ вместо 3990, а в подарок ты получишь видео-практикум "
                "«Деньги в моем Роду», рабочую тетрадь «Исследование своего Рода» и гайд "
                "«Генограмма – карта Рода».\n\n"
                "Подробности здесь: https://taplink.cc/margo_nostress/p/f6e80c/"
            )
            await message.answer(promo_text, disable_web_page_preview=True)

            await message.answer(
                "И помни: у тебя есть до 3 уточняющих вопросов по каждому разбору. "
                "Можешь спросить про любую сферу, которая тебя зацепила."
            )

        except Exception as e:
            logger.exception("Ошибка при повторном запросе к OpenAI: %s", e)
            await message.answer(
                "Сейчас у меня небольшие технические сложности. Попробуй ещё раз чуть позже."
            )

        return

    # 3. Если это не новый расчёт и не прогноз — считаем, что это уточняющий вопрос

    if state["last_answer"] and state["followup_count"] < MAX_FOLLOWUP_QUESTIONS:
        remaining_questions = MAX_FOLLOWUP_QUESTIONS - state["followup_count"] - 1

        await message.answer(
            f"Хороший вопрос, давай разберем.\n"
            f"(Останется уточняющих вопросов: {remaining_questions}.)"
        )

        try:
            answer = await asyncio.to_thread(
                ask_openai_followup,
                name,
                gender,
                dob,
                text,
                state["last_answer"],
            )
            state["followup_count"] += 1
            await send_long(message, answer)

            if state["followup_count"] >= MAX_FOLLOWUP_QUESTIONS:
                await message.answer(
                    "Это был твой третий уточняющий вопрос по этому разбору.\n"
                    "Если нужен новый разбор, напиши слово «матрица».\n"
                    "Если хочешь новый прогноз, напиши «прогноз 2026»."
                )

        except Exception as e:
            logger.exception("Ошибка при запросе уточнения к OpenAI: %s", e)
            await message.answer(
                "Сейчас у меня перегруз, ответ не сформировался. Попробуй задать вопрос ещё раз чуть позже."
            )

        return

    # Лимит уточняющих вопросов исчерпан
    if state["last_answer"] and state["followup_count"] >= MAX_FOLLOWUP_QUESTIONS:
        await message.answer(
            "Ты уже задал 3 уточняющих вопроса по последнему разбору.\n\n"
            "Если хочешь новый разбор Матрицы Рода — напиши «матрица».\n"
            "Если хочешь прогноз на год — напиши «прогноз 2026»."
        )
        return

    # Если сюда дошли: профайл есть, но ни разборов, ни вопросов, ни явного запроса
    await message.answer(
        "Я готов работать с твоей Матрицей Рода.\n\n"
        "Напиши «матрица», чтобы я сделал разбор по твоей дате рождения.\n"
        "Или «прогноз 2026», чтобы я посмотрел, каким для тебя будет 2026 год."
    )

# -------- ЗАПУСК --------

async def main():
    logger.info("Бот Профессор Альвасариус запущен.")
    await dp.start_polling(bot, allowed_updates=["message"])


if __name__ == "__main__":
    asyncio.run(main())




